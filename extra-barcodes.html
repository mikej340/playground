<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Museum Shop – Barcode Sheets</title>
  <style>
    /* ===== Print setup ===== */
    @page { size: A4; margin: 10mm; }

    :root {
      --gap: 3mm;
      --card-pad: 2.5mm;
      --border: 0.25mm;
      --radius: 2.5mm;
      --font: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }

    body {
      font-family: var(--font);
      margin: 0;
      padding: 0;
      color: #111;
      background: #fff;
      overflow-x: hidden;
    }

    header {
      position: sticky;
      top: 0;
      z-index: 10;
      background: white;
      border-bottom: 1px solid #ddd;
      padding: 10px 12px;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
    }
    header .spacer { flex: 1; }
    header label { font-size: 12px; }
    header select {
      font-size: 14px;
      padding: 6px 8px;
      border: 1px solid #ccc;
      border-radius: 8px;
      background: white;
    }
    header button {
      font-size: 14px;
      padding: 6px 10px;
      border: 1px solid #ccc;
      border-radius: 8px;
      background: #fff;
      cursor: pointer;
    }

    main { padding: 12px; max-width: 1200px; margin: 0 auto; box-sizing: border-box; }

    .status {
      font-size: 12px;
      color: #444;
      margin: 8px 0 12px;
    }

    .page { background: transparent; padding: 0; }

    .category { margin-bottom: 12px; }

    .category-title {
      font-weight: 800;
      font-size: 15px;
      margin: 0 0 8px;
      padding: 4px 0;
      border-bottom: 0.35mm solid #111;
      letter-spacing: 0.2px;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: var(--gap);
      align-content: start;
      align-items: start;
      grid-auto-rows: auto;
    }

    .card {
      border: var(--border) solid #111;
      border-radius: var(--radius);
      padding: var(--card-pad);
      display: flex;
      flex-direction: column;
      gap: 2mm;
      box-sizing: border-box;
      min-width: 0;
      align-self: start;
      break-inside: avoid;
      page-break-inside: avoid;
    }

    .name {
      font-weight: 800;
      font-size: 11px;
      line-height: 1.15;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 100%;
      display: block;
    }

    .imgwrap {
      border: none;
      background: transparent;
      padding: 0;
      border-radius: 0;
      overflow: visible;
      display: flex;
      align-items: center;
      justify-content: center;
      max-height: 42mm;
      min-height: 28mm;
      box-sizing: border-box;
    }

    .imgwrap img {
      max-width: min(100%, 50mm);
      max-height: min(100%, 32mm);
      width: auto;
      height: auto;
      object-fit: contain;
      display: block;
    }

    .barcode {
      display: grid;
      grid-template-columns: 1fr;
      gap: 1mm;
      align-items: end;
      margin-top: auto; /* align barcode bottoms */
    }

    .barcode img {
      width: 100%;
      height: 7mm;
      object-fit: contain;
      display: block;
    }

    .missing {
      font-size: 11px;
      color: #666;
      padding: 6px;
      text-align: center;
    }

    /* Paste panel */
    #pastePanel {
      display: none;
      margin: 0 0 12px;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 10px;
      background: #fff;
    }
    #pastePanel textarea {
      width: 100%;
      box-sizing: border-box;
      font: 12px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 8px;
    }

    @media print {
      body { background: white; }
      header, .status, #pastePanel { display: none !important; }
      main { padding: 0; max-width: none; margin: 0; }
      .page { padding: 0; }
      .category { page-break-after: always; margin-bottom: 10mm; }
      .category:last-child { page-break-after: auto; }
      /* Print: consistent row heights */
      .grid { align-items: stretch; }
      .card { align-self: stretch; }
    }
  </style>
</head>
<body>
  <header>
    <button id="togglePaste" type="button">Paste TSV</button>

    <label>
      Cache barcodes:
      <select id="cacheMode">
        <option value="on" selected>ON</option>
        <option value="force">Force fetch (refresh cache)</option>
        <option value="off">OFF</option>
      </select>
    </label>

    <label>
      Category:
      <select id="category"></select>
    </label>

    <label>
      Active only:
      <select id="activeOnly">
        <option value="true" selected>TRUE</option>
        <option value="false">FALSE</option>
      </select>
    </label>

    <label>
      Sort:
      <select id="sortMode">
        <option value="name" selected>Product Name</option>
        <option value="barcode">Barcode</option>
      </select>
    </label>

    <div class="spacer"></div>
    <button onclick="window.print()">Print</button>
  </header>

  <main>
    <div id="pastePanel">
      <div style="font-weight:800; margin-bottom:6px;">Paste TSV (copied rows from Google Sheets)</div>
      <textarea id="pastedData" rows="8" placeholder="Paste here (include the header row)…"></textarea>
      <div style="display:flex; gap:8px; margin-top:8px; flex-wrap:wrap;">
        <button id="loadPasted" type="button">Load pasted data</button>
        <button id="clearPasted" type="button">Clear</button>
        <div style="font-size:12px; color:#555; align-self:center;">Include the header row.</div>
      </div>
    </div>

    <div class="status" id="status">Paste TSV, then tap “Load pasted data”.</div>
    <div class="page" id="page"></div>
  </main>

  <script>
    /**
     * TSV-only loader + barcode caching.
     * Required headers (case-sensitive):
     * Product Name, Barcode, Active, Category, Symbology, Photo Drive ID, PhotoURL, BarcodeURL
     */

    const els = {
      togglePaste: document.getElementById('togglePaste'),
      pastePanel: document.getElementById('pastePanel'),
      pastedData: document.getElementById('pastedData'),
      loadPasted: document.getElementById('loadPasted'),
      clearPasted: document.getElementById('clearPasted'),
      category: document.getElementById('category'),
      activeOnly: document.getElementById('activeOnly'),
      sortMode: document.getElementById('sortMode'),
      cacheMode: document.getElementById('cacheMode'),
      status: document.getElementById('status'),
      page: document.getElementById('page'),
    };

    function escapeHtml(s) {
      return String(s ?? '')
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#39;');
    }

    function setStatus(msg) { els.status.textContent = msg; }

    function normalizeBool(v) {
      const s = String(v ?? '').trim().toLowerCase();
      if (s === 'true') return true;
      if (s === 'false') return false;
      return null;
    }

    function stripSpaces(s) { return String(s ?? '').split(' ').join(''); }

    function byBarcode(a, b) {
      const as = stripSpaces(a);
      const bs = stripSpaces(b);
      const an = Number(as);
      const bn = Number(bs);
      if (!Number.isNaN(an) && !Number.isNaN(bn)) return an - bn;
      return as.localeCompare(bs);
    }

    function parseTSV(text) {
      const t = String(text || '').replace(/\r\n/g, '\n').replace(/\r/g, '\n');
      const lines = t.split('\n');
      const rows = [];
      for (const line of lines) {
        if (!line) continue;
        rows.push(line.split('\t'));
      }
      return rows;
    }

    // --- Barcode cache (high compatibility: localStorage + base64 data URLs) ---
    const BARCODE_CACHE_PREFIX = 'barcode_cache_v1|';

    function cacheKeyFromUrl(url) { return BARCODE_CACHE_PREFIX + String(url || '').trim(); }

    function getCachedBarcodeDataUrl(url) {
      try { return localStorage.getItem(cacheKeyFromUrl(url)) || ''; } catch { return ''; }
    }

    function setCachedBarcodeDataUrl(url, dataUrl) {
      try { localStorage.setItem(cacheKeyFromUrl(url), dataUrl); } catch { /* ignore */ }
    }

    function clearCachedBarcode(url) {
      try { localStorage.removeItem(cacheKeyFromUrl(url)); } catch { /* ignore */ }
    }

    async function fetchAsDataUrl(url) {
      const res = await fetch(url, { cache: 'force-cache' });
      if (!res.ok) throw new Error('Fetch failed');
      const blob = await res.blob();
      return await new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(String(reader.result || ''));
        reader.onerror = () => reject(new Error('Read failed'));
        reader.readAsDataURL(blob);
      });
    }

    async function ensureBarcodeCached(url, mode) {
      const u = String(url || '').trim();
      if (!u) return '';
      if (mode === 'off') return u;

      const existing = getCachedBarcodeDataUrl(u);
      if (mode !== 'force' && existing) return existing;

      if (mode === 'force') clearCachedBarcode(u);

      try {
        const dataUrl = await fetchAsDataUrl(u);
        if (dataUrl && dataUrl.startsWith('data:')) {
          setCachedBarcodeDataUrl(u, dataUrl);
          return dataUrl;
        }
      } catch {
        // If CORS blocks fetch(), fall back to direct URL
      }

      return u;
    }

    function refreshVisibleBarcodes() {
      const mode = (els.cacheMode?.value || 'on');
      const imgs = els.page.querySelectorAll('img[data-barcode-url]');
      imgs.forEach(img => {
        const url = img.getAttribute('data-barcode-url') || '';
        if (!url) return;

        if (mode === 'on') {
          const cached = getCachedBarcodeDataUrl(url);
          if (cached) { img.src = cached; return; }
        }

        ensureBarcodeCached(url, mode).then(src => { if (src) img.src = src; });
      });
    }

    function buildCategoryDropdown(records) {
      const cats = Array.from(new Set(records.map(r => r.Category).filter(Boolean)))
        .sort((a, b) => a.localeCompare(b, undefined, { sensitivity: 'base' }));

      els.category.innerHTML = [
        '<option value="__ALL__">All categories</option>',
        ...cats.map(c => `<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`)
      ].join('');
    }

    let CURRENT_RECORDS = [];

    function render(records) {
      const activeOnly = els.activeOnly.value === 'true';
      const selectedCategory = els.category.value;
      const sortMode = els.sortMode.value;

      let filtered = records.slice();
      if (activeOnly) filtered = filtered.filter(r => r.Active === true);
      if (selectedCategory !== '__ALL__') filtered = filtered.filter(r => r.Category === selectedCategory);

      filtered.sort((a, b) => {
        if (sortMode === 'barcode') return byBarcode(a.Barcode, b.Barcode);
        return String(a['Product Name'] ?? '').localeCompare(String(b['Product Name'] ?? ''), undefined, { sensitivity: 'base' });
      });

      const groups = new Map();
      for (const r of filtered) {
        const cat = r.Category || 'Uncategorised';
        if (!groups.has(cat)) groups.set(cat, []);
        groups.get(cat).push(r);
      }

      const catsInOrder = Array.from(groups.keys()).sort((a, b) => a.localeCompare(b, undefined, { sensitivity: 'base' }));

      const html = catsInOrder.map(cat => {
        const cards = groups.get(cat).map(r => {
          const name = escapeHtml(r['Product Name'] ?? '');

          const driveId = (r['Photo Drive ID'] || '').trim();
          const photoUrl = driveId
            ? `https://drive.google.com/thumbnail?id=${driveId}&sz=w1200`
            : (r.PhotoURL || '').trim();

          const barcodeUrl = (r.BarcodeURL || '').trim();

          const photoHtml = photoUrl
            ? `<img src="${escapeHtml(photoUrl)}" alt="${name}" />`
            : '<div class="missing">No photo</div>';

          const barcodeImg = barcodeUrl
            ? `<img src="${escapeHtml(barcodeUrl)}" data-barcode-url="${escapeHtml(barcodeUrl)}" alt="Barcode" />`
            : '<div class="missing">No barcode image</div>';

          return `
            <div class="card">
              <div class="name">${name}</div>
              <div class="imgwrap">${photoHtml}</div>
              <div class="barcode">${barcodeImg}</div>
            </div>
          `;
        }).join('');

        return `
          <section class="category">
            <h2 class="category-title">${escapeHtml(cat)}</h2>
            <div class="grid">${cards}</div>
          </section>
        `;
      }).join('');

      els.page.innerHTML = html || '<div class="missing">No matching items.</div>';
      setStatus(`${filtered.length} items • ${catsInOrder.length} categories`);

      refreshVisibleBarcodes();
    }

    function parseAndLoadFromTSV(tsvText) {
      const rows = parseTSV(tsvText).filter(r => r.some(cell => String(cell ?? '').trim() !== ''));
      if (rows.length < 2) throw new Error('TSV looks empty (need header row + at least 1 data row).');

      const header = rows[0].map(h => String(h ?? '').trim());
      const idx = Object.fromEntries(header.map((h, i) => [h, i]));

      const required = ['Product Name', 'Barcode', 'Active', 'Category', 'Symbology', 'Photo Drive ID', 'PhotoURL', 'BarcodeURL'];
      const missing = required.filter(h => !(h in idx));
      if (missing.length) throw new Error(`Missing required columns: ${missing.join(', ')}`);

      const records = rows.slice(1).map(r => {
        const obj = {};
        for (const h of header) obj[h] = r[idx[h]] ?? '';
        obj.Active = normalizeBool(obj.Active);
        obj.Category = String(obj.Category ?? '').trim();
        obj['Product Name'] = String(obj['Product Name'] ?? '').trim();
        obj.Barcode = String(obj.Barcode ?? '').trim();
        obj.Symbology = String(obj.Symbology ?? '').trim();
        obj['Photo Drive ID'] = String(obj['Photo Drive ID'] ?? '').trim();
        obj.PhotoURL = String(obj.PhotoURL ?? '').trim();
        obj.BarcodeURL = String(obj.BarcodeURL ?? '').trim();
        return obj;
      });

      CURRENT_RECORDS = records;
      buildCategoryDropdown(records);
      render(records);
    }

    function showError(title, message) {
      setStatus(`Error: ${message}`);
      els.page.innerHTML = `
        <div style="padding:12px;border:1px solid #c00;border-radius:10px;background:#fff0f0;color:#400;max-width:900px;">
          <div style="font-weight:800;margin-bottom:6px;">${escapeHtml(title)}</div>
          <div style="font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace; white-space:pre-wrap;">${escapeHtml(message)}</div>
        </div>
      `;
    }

    // UI wiring
    els.togglePaste.addEventListener('click', () => {
      const open = els.pastePanel.style.display !== 'none';
      els.pastePanel.style.display = open ? 'none' : 'block';
      if (!open) els.pastedData.focus();
    });

    els.clearPasted.addEventListener('click', () => {
      els.pastedData.value = '';
      els.pastedData.focus();
    });

    els.loadPasted.addEventListener('click', () => {
      try {
        const t = (els.pastedData.value || '').trim();
        if (!t) throw new Error('Paste TSV first (include the header row).');
        parseAndLoadFromTSV(t);
        els.pastePanel.style.display = 'none';
      } catch (err) {
        showError('Failed to load pasted TSV', err.message);
      }
    });

    function rerender() {
      if (!CURRENT_RECORDS.length) return;
      render(CURRENT_RECORDS);
    }

    els.category.addEventListener('change', rerender);
    els.activeOnly.addEventListener('change', rerender);
    els.sortMode.addEventListener('change', rerender);
    els.cacheMode.addEventListener('change', () => {
      // Force refresh cached barcodes if requested
      refreshVisibleBarcodes();
    });

    // Default: show paste panel
    els.pastePanel.style.display = 'block';
  </script>
</body>
</html>
